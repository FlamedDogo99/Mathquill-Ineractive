/**
 * Undo manager
 */
const TAB_KEYCODE=9,ENTER_KEYCODE=13,SHIFT_KEYCODE=16,CTRL_KEYCODE=17,ALT_KEYCODE=18,CAPSLOCK_KEYCODE=20,ESCAPE_KEYCODE=27,PAGEUP_KEYCODE=33,PAGEDOWN_KEYCODE=34,END_KEYCODE=35,HOME_KEYCODE=36,LEFTARROW_KEYCODE=37,UPARROW_KEYCODE=38,RIGHTARROW_KEYCODE=39,DOWNARROW_KEYCODE=40,V_KEYCODE=86,Y_KEYCODE=89,Z_KEYCODE=90,ALTGR_KEYCODE=225,unaffectingKeys=[9,13,16,17,18,20,27,37,33,34,35,36,37,38,39,40,225];function UndoRedoManager(t,e){this.mathField=t,this.contentEl=e,this.typedHistory=[this.mathField.latex()],this.ctrlIsDown=!1,this.YIsDown=!1,this.ZIsDown=!1,this.currentState=0,this.buffSize=50,this.rearrangeTypedArray=()=>{if(this.typedHistory.length>this.buffSize){let t=this.typedHistory.length-this.buffSize;this.currentState=this.currentState-t,this.typedHistory=this.typedHistory.slice(-1*this.buffSize)}},this.isKeyIsUnaffecting=t=>unaffectingKeys.includes(t),this.checkIfSpecialKeysAreUpAndSetStates=t=>{this.ctrlIsDown=t.metaKey||t.ctrlKey;let e="z"==t.key||90==t.which||90==t.keyCode;this.ZIsDown=e&&!t.shiftKey,this.YIsDown=e&&t.shiftKey},this.checkIfSpecialKeysAreDownAndSetStates=t=>{this.ctrlIsDown=!0===t.metaKey||!0===t.ctrlKey;let e="z"==t.key||90==t.which||90==t.keyCode;this.ZIsDown=e&&!1===t.shiftKey,this.YIsDown=e&&!0===t.shiftKey},this.saveState=()=>{this.currentState!==this.typedHistory.length-1&&(this.typedHistory=this.typedHistory.slice(0,this.currentState+1)),this.typedHistory.push(this.mathField.latex()),this.rearrangeTypedArray(),this.currentState++},this.undo=()=>{if(0!==this.currentState){this.currentState--;let t=this.typedHistory[this.currentState];t=t.replace(/\\newline/g,"\\embed{linebreak}"),this.mathField.latex(t),this.mathField.focus()}},this.redo=()=>{if(this.currentState<this.typedHistory.length-1){this.currentState++;let t=this.typedHistory[this.currentState];t=t.replace(/\\newline/g,"\\embed{linebreak}"),this.mathField.latex(t),this.mathField.focus()}},this.contentEl.on("keyup",t=>{this.checkIfSpecialKeysAreUpAndSetStates(t),!1===this.isKeyIsUnaffecting(t.which)&&(!1===this.ctrlIsDown||this.ctrlIsDown&&86===t.which)&&this.saveState()}),this.contentEl.on("keydown",t=>{this.checkIfSpecialKeysAreDownAndSetStates(t),this.ctrlIsDown&&this.ZIsDown&&this.undo(),this.ctrlIsDown&&this.YIsDown&&this.redo()})}

/**
 * Touch handler
 */
let undoButton=document.getElementById("undo"),redoButton=document.getElementById("redo"),copyButton=document.getElementById("copy"),pasteButton=document.getElementById("paste");function preventButton(e){return e.preventDefault(),!1}function TouchEventMapper(e){let t;e.target;switch(e.type){case"touchstart":t="mousedown";break;case"touchmove":t="mousemove";break;case"touchend":case"touchcancel":t="mouseup";break;default:return}let n=e.changedTouches[0],o=n.clientX,a=n.pageX,c=window.pageXOffset,r=n.clientY,d=n.pageY,u=window.pageYOffset;0===a&&Math.floor(o)>Math.floor(a)||0===d&&Math.floor(r)>Math.floor(d)?(o-=c,r-=u):(o<a-c||r<d-u)&&(o=a-c,r=d-u);let i=new MouseEvent(t,{bubbles:!0,cancelable:!0,screenX:n.screenX,screenY:n.screenY,clientX:n.clientX,clientY:n.clientY,pageX:n.pageX,pageY:n.pageU,buttons:1,button:0,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey});this.dispatchEvent(i)}undoButton.addEventListener("pointerdown",preventButton,!1),redoButton.addEventListener("pointerdown",preventButton,!1),copyButton.addEventListener("pointerdown",preventButton,!1),pasteButton.addEventListener("pointerdown",preventButton,!1),undoButton.addEventListener("click",(e=>(undoManager.redo(),!1)),!1),redoButton.addEventListener("click",(e=>(undoManager.undo(),!1)),!1),copyButton.addEventListener("click",(e=>{if(mathField.__controller.cursor.selection){const e=mathField.__controller.cursor.selection.join("latex");navigator.clipboard.writeText(`${e}`),mathField.focus()}}),!1),pasteButton.addEventListener("click",(async e=>(navigator.clipboard.readText().then((e=>{const t=new window.DataTransfer;t.setData("text/plain",e),document.activeElement.dispatchEvent(new ClipboardEvent("paste",{bubbles:!0,cancelable:!0,clipboardData:t}))})),!1)),!1),document.querySelector("#math-field").addEventListener("touchstart",TouchEventMapper,!0),document.addEventListener("touchmove",TouchEventMapper,!0),document.addEventListener("touchend",TouchEventMapper,!0),document.addEventListener("touchcancel",TouchEventMapper,!0);
/**
 * Setup
 */
const L="left",R="right",MQ=MathQuill.getInterface(2);function setupMathField(){MQ.registerEmbed("linebreak",function(){let e=document.createElement("span");return e.className="mq-line-break",{htmlString:e.outerHTML,text:function(){return"\\newline"},latex:function(){return"\\newline"}}}),mathFieldEl=$("#math-field");let e=MQ.MathField(document.getElementById("math-field"),{spaceBehavesLikeTab:!1,restrictMismatchedBrackets:!1,autoCommands:"alpha beta sqrt theta phi rho pi tau nthroot cbrt sum prod integral percent infinity infty cross ans frac int gamma Gamma delta Delta epsilon zeta eta Theta iota kappa lambda Lambda mu Xi xi Pi sigma Sigma upsilon Upsilon Phi chi psi Psi omega Omega",charsThatBreakOutOfSupSub:"",handlers:{edit:function(){let t=e.latex();t=t.replace(/\\embed{linebreak}/g,"\\newline"),document.getElementById("latex-output").value=t}}});return undoManager=new UndoRedoManager(e,mathFieldEl),document.getElementById("math-field").addEventListener("keydown",function(t){if("Enter"===t.key){t.preventDefault(),e.write("\\embed{linebreak}");let a=e.latex();a=a.replace(/\\embed{linebreak}/g,"\\newline"),document.getElementById("latex-output").value=a}else("ArrowUp"===t.key||"ArrowDown"===t.key)&&(t.preventDefault(),moveCursorManually(e,"ArrowUp"===t.key?"up":"down"))}),document.getElementById("math-field").addEventListener("paste",mathPaste,!1),e}function mathPaste(e){e.preventDefault(),e.stopPropagation();let t=(e.clipboardData||window.clipboardData).getData("Text");t=t.replace(/\\newline/g,"\\embed{linebreak}"),mathField.__controller.cursor.deleteSelection(),mathField.write(t),mathField.__controller.textarea[0].value="";let a=mathField.latex();a=a.replace(/\\embed{linebreak}/g,"\\newline"),document.getElementById("latex-output").value=a}function sourceHandler(e){let t=this.value;t&&(t=t.replace(/\\newline/g,"\\embed{linebreak}"),mathField.latex(t),undoManager.saveState())}function moveCursorManually(e,t){let a=e.__controller.cursor,n=getCurrentLine(a),l="up"===t?n-1:n+1,r=getCursorPosInLine(a),i=getLineNode(a,n,l,t);i&&moveToClosestPosition(a,l,i,r,t)}function getCurrentLine(e){let t=0,a=e[MQ.L];for(;a;)a.jQ&&a.jQ.hasClass("mq-line-break")&&t++,a=a[MQ.L];return t}function getCursorPosInLine(e){let t=0,a=e[MQ.L];for(;a&&!(a.jQ&&a.jQ.hasClass("mq-line-break"));)t++,a=a[MQ.L];return t}function getLineNode(e,t,a,n){let l=t;if("up"==n){for(var r=e[MQ.L];r;){if(r.jQ&&r.jQ.hasClass("mq-line-break")&&(r=r[MQ.L],l--),a==l)return r[MQ.L];r=r[MQ.L]}return null}for(var r=e[MQ.R];r;){if(r.jQ&&r.jQ.hasClass("mq-line-break")&&(r=r[MQ.R],l++),a==l)return r;r=r[MQ.R]}return null}function moveToClosestPosition(e,t,a,n,l){e.insRightOf(a);let r=getCursorPosInLine(e);if(n<r){let i=r-n,o=a;for(let s=0;s<i;s++){var u=o[MQ.L];if(!u)break;if(u.jQ&&u.jQ.hasClass("mq-line-break")){o=u;break}o=u}if("up"==l&&0==t&&0==n)for(;e[MQ.L];)e.insLeftOf(e[MQ.L]);else e.insRightOf(o)}else if(n>r){let m=n-r,d=a;for(let f=0;f<m;f++){var u=d[MQ.R];if(!u||u.jQ&&u.jQ.hasClass("mq-line-break"))break;d=u}e.insRightOf(d)}e.show()}(latexSource=document.getElementById("latex-output")).addEventListener("input",sourceHandler,!1);const mathField=setupMathField();

